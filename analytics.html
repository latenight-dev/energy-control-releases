<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Energy Control — Landing Analytics</title>
  <meta name="robots" content="noindex, nofollow">

  <!-- Fonts (same as landing) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">

  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #050505;
      --bg-card: #111111;
      --border: #1e1e1e;
      --text: #f0f0f0;
      --text-dim: #888;
      --text-muted: #555;
      --green: #00e676;
      --yellow: #ffd600;
      --cyan: #00e5ff;
      --purple: #b388ff;
      --red: #ff1744;
      --font: 'Outfit', sans-serif;
      --mono: 'JetBrains Mono', monospace;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.6rem;
      font-weight: 800;
      letter-spacing: -0.03em;
      margin-bottom: 4px;
    }
    h1 .accent {
      background: linear-gradient(135deg, var(--green), var(--yellow));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle { color: var(--text-dim); font-size: 0.85rem; margin-bottom: 24px; }

    /* Controls */
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }
    .controls select, .controls button {
      font-family: var(--mono);
      font-size: 0.8rem;
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text);
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .controls select:hover, .controls button:hover {
      border-color: var(--green);
    }
    .controls button.active {
      background: var(--green);
      color: #000;
      border-color: var(--green);
    }
    .status {
      margin-left: auto;
      font-size: 0.75rem;
      color: var(--text-muted);
      font-family: var(--mono);
    }

    /* Summary cards */
    .summary-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    .summary-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px 24px;
    }
    .summary-card .label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .summary-card .value {
      font-family: var(--mono);
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--green);
    }

    /* Data sections */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }
    @media (max-width: 768px) {
      .grid-2 { grid-template-columns: 1fr; }
    }

    .panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }
    .panel h3 {
      font-size: 0.9rem;
      font-weight: 700;
      margin-bottom: 16px;
      letter-spacing: -0.01em;
    }
    .panel h3 i { margin-right: 8px; color: var(--text-dim); }

    /* Bar chart (CSS-only) */
    .bar-chart { display: flex; flex-direction: column; gap: 8px; }
    .bar-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .bar-label {
      width: 90px;
      font-size: 0.8rem;
      font-family: var(--mono);
      color: var(--text-dim);
      text-align: right;
      flex-shrink: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .bar-track {
      flex: 1;
      height: 22px;
      background: rgba(255,255,255,0.03);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .bar-fill {
      height: 100%;
      border-radius: 4px;
      background: var(--green);
      transition: width 0.5s ease;
      min-width: 2px;
    }
    .bar-fill.yellow { background: var(--yellow); }
    .bar-fill.cyan   { background: var(--cyan); }
    .bar-fill.purple { background: var(--purple); }
    .bar-fill.red    { background: var(--red); }
    .bar-count {
      width: 50px;
      font-size: 0.75rem;
      font-family: var(--mono);
      color: var(--text-dim);
      flex-shrink: 0;
    }

    /* Table */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    .data-table th, .data-table td {
      text-align: left;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
    }
    .data-table th {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      font-weight: 600;
    }
    .data-table td { font-family: var(--mono); color: var(--text-dim); }

    /* Daily chart (sparkline-style) */
    .daily-chart {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 120px;
      padding-top: 8px;
    }
    .daily-bar {
      flex: 1;
      background: var(--green);
      border-radius: 2px 2px 0 0;
      min-height: 2px;
      opacity: 0.7;
      position: relative;
      transition: opacity 0.2s;
      cursor: default;
    }
    .daily-bar:hover { opacity: 1; }
    .daily-bar .tip {
      display: none;
      position: absolute;
      bottom: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      color: var(--text);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-family: var(--mono);
      white-space: nowrap;
      z-index: 10;
    }
    .daily-bar:hover .tip { display: block; }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-muted);
    }
    .empty-state i { font-size: 2rem; margin-bottom: 12px; display: block; }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-bottom: 24px;
      transition: color 0.2s;
    }
    .back-link:hover { color: var(--green); }
  </style>
</head>
<body>

  <!-- Login Gate -->
  <div id="loginGate" style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:80vh;gap:16px;">
    <i class="fas fa-lock" style="font-size:2.5rem;color:var(--green);"></i>
    <h2 style="font-weight:800;letter-spacing:-0.03em;">Analytics Dashboard</h2>
    <p style="color:var(--text-dim);font-size:0.85rem;max-width:320px;text-align:center;">Enter the API secret to continue. This is the same secret shown in your server console on startup.</p>
    <input id="secretInput" type="password" placeholder="API secret" style="font-family:var(--mono);font-size:0.85rem;padding:10px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card);color:var(--text);width:320px;text-align:center;" autofocus />
    <button id="loginBtn" style="font-family:var(--font);font-size:0.85rem;font-weight:600;padding:10px 32px;border-radius:8px;border:none;background:var(--green);color:#000;cursor:pointer;">Unlock</button>
    <p id="loginError" style="color:var(--red);font-size:0.8rem;display:none;">Invalid secret — check your server console.</p>
  </div>

  <!-- Dashboard (hidden until authenticated) -->
  <div id="dashboard" style="display:none;">
  <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to landing page</a>

  <h1><i class="fas fa-chart-bar"></i> Landing <span class="accent">Analytics</span></h1>
  <p class="subtitle">Privacy-friendly visitor statistics — no cookies, no PII, no tracking pixels.</p>

  <div class="controls">
    <select id="period">
      <option value="7">Last 7 days</option>
      <option value="14">Last 14 days</option>
      <option value="30" selected>Last 30 days</option>
      <option value="90">Last 90 days</option>
      <option value="365">Last year</option>
    </select>
    <button id="refreshBtn" onclick="loadData()"><i class="fas fa-sync-alt"></i> Refresh</button>
    <span class="status" id="status">Loading…</span>
  </div>

  <!-- Summary Cards -->
  <div class="summary-row" id="summary">
    <div class="summary-card"><div class="label">Page Views</div><div class="value" id="s-views">—</div></div>
    <div class="summary-card"><div class="label">Unique Visitors</div><div class="value" id="s-unique">—</div></div>
    <div class="summary-card"><div class="label">Download Clicks</div><div class="value" id="s-downloads">—</div></div>
    <div class="summary-card"><div class="label">Total Events</div><div class="value" id="s-events">—</div></div>
  </div>

  <!-- Daily Views Chart -->
  <div class="panel" style="margin-bottom: 24px;">
    <h3><i class="fas fa-chart-area"></i> Daily Page Views</h3>
    <div class="daily-chart" id="dailyChart"></div>
  </div>

  <!-- Two-column panels -->
  <div class="grid-2">
    <div class="panel">
      <h3><i class="fas fa-desktop"></i> Visitor OS</h3>
      <div class="bar-chart" id="osChart"></div>
    </div>
    <div class="panel">
      <h3><i class="fas fa-download"></i> Downloads by OS</h3>
      <div class="bar-chart" id="downloadChart"></div>
    </div>
  </div>

  <div class="grid-2">
    <div class="panel">
      <h3><i class="fas fa-link"></i> Top Referrers</h3>
      <div class="bar-chart" id="referrerChart"></div>
    </div>
    <div class="panel">
      <h3><i class="fas fa-eye"></i> Section Engagement</h3>
      <div class="bar-chart" id="sectionChart"></div>
    </div>
  </div>

  <div class="grid-2">
    <div class="panel">
      <h3><i class="fas fa-mouse-pointer"></i> Nav Clicks</h3>
      <div class="bar-chart" id="navChart"></div>
    </div>
    <div class="panel">
      <h3><i class="fas fa-expand"></i> Screen Sizes</h3>
      <div class="bar-chart" id="screenChart"></div>
    </div>
  </div>

  <!-- Recent Events Table -->
  <div class="panel" style="margin-top: 24px;">
    <h3><i class="fas fa-list"></i> Recent Events</h3>
    <div style="overflow-x: auto;">
      <table class="data-table" id="eventsTable">
        <thead>
          <tr>
            <th>Time</th>
            <th>Event</th>
            <th>OS</th>
            <th>Details</th>
            <th>Referrer</th>
          </tr>
        </thead>
        <tbody id="eventsBody"></tbody>
      </table>
    </div>
  </div>

  </div><!-- /dashboard -->

  <script>
    // Auto-detect API base: same origin if served from backend, otherwise localhost:4000 for dev
    const API_BASE = (location.port === '4000' || location.port === '')
      ? '/api'
      : 'http://localhost:4000/api';
    const $ = (id) => document.getElementById(id);

    // ── Auth gate ──
    let _secret = sessionStorage.getItem('analytics_secret') || '';

    function authHeaders() {
      return { 'x-api-secret': _secret };
    }

    function showDashboard() {
      $('loginGate').style.display = 'none';
      $('dashboard').style.display = 'block';
    }

    async function tryLogin(secret) {
      _secret = secret;
      try {
        const res = await fetch(`${API_BASE}/landing/analytics?days=1`, { headers: authHeaders() });
        if (res.ok) {
          sessionStorage.setItem('analytics_secret', secret);
          showDashboard();
          loadData();
          return true;
        }
      } catch {}
      $('loginError').style.display = 'block';
      return false;
    }

    $('loginBtn').addEventListener('click', () => tryLogin($('secretInput').value.trim()));
    $('secretInput').addEventListener('keydown', e => { if (e.key === 'Enter') tryLogin($('secretInput').value.trim()); });

    // Auto-login if secret is saved in session
    if (_secret) tryLogin(_secret);

    const BAR_COLORS = ['', 'yellow', 'cyan', 'purple', 'red'];

    function renderBarChart(containerId, items, maxItems = 10) {
      const el = $(containerId);
      if (!items || items.length === 0) {
        el.innerHTML = '<div style="color:var(--text-muted);font-size:0.8rem;">No data yet</div>';
        return;
      }
      const max = Math.max(...items.map(i => i.count), 1);
      el.innerHTML = items.slice(0, maxItems).map((item, idx) => `
        <div class="bar-row">
          <div class="bar-label" title="${item.label}">${item.label}</div>
          <div class="bar-track">
            <div class="bar-fill ${BAR_COLORS[idx % BAR_COLORS.length]}" style="width:${(item.count / max * 100).toFixed(1)}%"></div>
          </div>
          <div class="bar-count">${item.count.toLocaleString()}</div>
        </div>
      `).join('');
    }

    function renderDailyChart(data) {
      const el = $('dailyChart');
      if (!data || data.length === 0) {
        el.innerHTML = '<div style="color:var(--text-muted);font-size:0.8rem;width:100%;text-align:center;">No data yet</div>';
        return;
      }
      const max = Math.max(...data.map(d => d.views), 1);
      el.innerHTML = data.map(d => {
        const pct = (d.views / max * 100).toFixed(1);
        return `<div class="daily-bar" style="height:${pct}%"><div class="tip">${d.day}<br>${d.views} views · ${d.unique_visitors} unique</div></div>`;
      }).join('');
    }

    function renderEventsTable(events) {
      const tbody = $('eventsBody');
      if (!events || events.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">No events recorded yet</td></tr>';
        return;
      }
      tbody.innerHTML = events.slice(0, 50).map(e => {
        const time = new Date(e.created_at + 'Z').toLocaleString();
        let details = '';
        if (e.download_os) details = `${e.download_os}${e.variant ? ' (' + e.variant + ')' : ''}`;
        else if (e.section) details = e.section;
        else if (e.target) details = e.target;
        return `<tr>
          <td>${time}</td>
          <td>${e.event}</td>
          <td>${e.os || '—'}</td>
          <td>${details || '—'}</td>
          <td>${e.referrer || '—'}</td>
        </tr>`;
      }).join('');
    }

    async function loadData() {
      const days = $('period').value;
      $('status').textContent = 'Loading…';

      try {
        const [analyticsRes, rawRes] = await Promise.all([
          fetch(`${API_BASE}/landing/analytics?days=${days}`, { headers: authHeaders() }),
          fetch(`${API_BASE}/landing/analytics/raw?days=${days}&limit=50`, { headers: authHeaders() }),
        ]);

        if (!analyticsRes.ok) throw new Error(`HTTP ${analyticsRes.status}`);
        const { data } = await analyticsRes.json();
        const raw = rawRes.ok ? (await rawRes.json()).data : [];

        // Summary
        const pageViews = data.event_counts.find(e => e.event === 'page_view')?.count || 0;
        $('s-views').textContent = pageViews.toLocaleString();
        $('s-unique').textContent = (data.summary.unique_visitors || 0).toLocaleString();
        $('s-downloads').textContent = (data.summary.total_downloads || 0).toLocaleString();
        $('s-events').textContent = (data.summary.total_events || 0).toLocaleString();

        // Charts
        renderDailyChart(data.daily_views);

        renderBarChart('osChart', (data.os_breakdown || []).map(o => ({
          label: o.os || 'unknown',
          count: o.count,
        })));

        // Combine downloads + hero clicks
        const dlMap = {};
        (data.downloads_by_os || []).forEach(d => {
          const key = d.download_os || 'unknown';
          dlMap[key] = (dlMap[key] || 0) + d.count;
        });
        (data.hero_clicks || []).forEach(d => {
          const key = d.download_os || 'unknown';
          dlMap[key] = (dlMap[key] || 0) + d.count;
        });
        renderBarChart('downloadChart', Object.entries(dlMap).map(([label, count]) => ({ label, count })).sort((a, b) => b.count - a.count));

        renderBarChart('referrerChart', (data.referrers || []).map(r => ({
          label: r.referrer || 'direct',
          count: r.count,
        })));

        renderBarChart('sectionChart', (data.section_views || []).map(s => ({
          label: s.section || '?',
          count: s.count,
        })));

        renderBarChart('navChart', (data.nav_clicks || []).map(n => ({
          label: n.target || '?',
          count: n.count,
        })));

        renderBarChart('screenChart', (data.screen_sizes || []).map(s => ({
          label: s.screen || '?',
          count: s.count,
        })));

        // Events table
        renderEventsTable(raw);

        $('status').textContent = `Updated ${new Date().toLocaleTimeString()}`;
      } catch (err) {
        console.error('Analytics load error:', err);
        $('status').textContent = `Error: ${err.message}`;
      }
    }

    // Load on period change + auto-refresh (loadData called after login)
    $('period').addEventListener('change', loadData);
    setInterval(() => { if ($('dashboard').style.display !== 'none') loadData(); }, 60_000);
  </script>

</body>
</html>
